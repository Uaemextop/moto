name: "Copilot Setup Steps — Download & Decompile LMSA Binaries"

# This workflow ONLY downloads the original LMSA binaries and decompiles them.
# It does NOT create, restore, or build any project. The agent must create the
# entire open-source application from scratch based on the decompiled reference.

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # The job MUST be named exactly "copilot-setup-steps"
  copilot-setup-steps:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Install .NET SDK (needed only for ilspycmd decompilation tool)
      - name: Set up .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0'

      # Install ILSpy for recursive decompilation
      - name: Install ILSpy decompilation tool
        run: dotnet tool install --global ilspycmd

      # Download the original LMSA binaries from Dropbox
      - name: Download LMSA original binaries
        run: |
          mkdir -p decompiled/reference
          echo "Downloading LMSA original binaries..."
          wget -q -O /tmp/lmsa.zip "https://www.dropbox.com/scl/fi/3kuolvy11282n0q0pw99b/examples.zip?rlkey=1rldjq71q8igq0ban9lg9homn&st=07i1mewd&dl=1"
          unzip -o -q /tmp/lmsa.zip -d decompiled/reference
          rm -f /tmp/lmsa.zip
          echo "=== Reference binaries inventory ==="
          find decompiled/reference -type f \( -iname "*.dll" -o -iname "*.exe" \) | wc -l
          echo " .NET binaries found for decompilation"

      # Recursively decompile ALL .NET DLLs and EXEs (including plugins/)
      - name: Decompile all .NET assemblies (recursive)
        run: |
          mkdir -p decompiled/reference-src

          find decompiled/reference -type f \( -iname "*.dll" -o -iname "*.exe" \) 2>/dev/null | sort | while read binary; do
            rel="${binary#decompiled/reference/}"
            name="${rel%.*}"
            outdir="decompiled/reference-src/${name}"
            mkdir -p "$outdir"

            if ilspycmd "$binary" -p -o "$outdir" 2>/dev/null; then
              cs_count=$(find "$outdir" -name "*.cs" 2>/dev/null | wc -l)
              if [ "$cs_count" -gt 0 ]; then
                echo "✓ Decompiled ($cs_count .cs files): $rel"
              else
                rm -rf "$outdir" 2>/dev/null || true
              fi
            else
              echo "✗ Skipped (not .NET): $rel"
              rm -rf "$outdir" 2>/dev/null || true
            fi
          done

          echo ""
          echo "=== DECOMPILATION SUMMARY ==="
          total=$(find decompiled/reference-src -name "*.cs" 2>/dev/null | wc -l)
          echo "Total .cs files generated: $total"
          echo ""
          echo "=== Lenovo custom assemblies ==="
          for dir in decompiled/reference-src/lenovo.mbg.service.*; do
            [ -d "$dir" ] && echo "  $(basename $dir): $(find "$dir" -name '*.cs' | wc -l) files"
          done
          echo ""
          echo "=== Main application ==="
          [ -d "decompiled/reference-src/Software Fix" ] && echo "  Software Fix: $(find 'decompiled/reference-src/Software Fix' -name '*.cs' | wc -l) files"
          echo ""
          echo "=== Plugin directories ==="
          if [ -d "decompiled/reference-src/plugins" ]; then
            for dir in decompiled/reference-src/plugins/*/; do
              guid=$(basename "$dir")
              count=$(find "$dir" -name "*.cs" | wc -l)
              main_asm=$(find "$dir" -maxdepth 1 -type d -name "lenovo.mbg.service.lmsa.*" 2>/dev/null | head -1 | xargs basename 2>/dev/null || echo "unknown")
              echo "  $guid ($main_asm): $count files"
            done
          fi

      # Cache decompiled sources so subsequent runs are faster
      - name: Cache decompiled sources
        uses: actions/cache@v4
        with:
          path: decompiled/
          key: lmsa-decompiled-${{ hashFiles('.github/workflows/copilot-setup-steps.yml') }}
          restore-keys: |
            lmsa-decompiled-
